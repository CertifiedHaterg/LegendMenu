-- ====================== VEHICLE FEATURES ======================
-- Rainbow Vehicle
CreateThread(function()
    local r, g, b = 0, 0, 255
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.rainbowVehicle then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if veh ~= 0 then
                -- Rainbow color cycle
                if r == 255 and g < 255 and b == 0 then g = g + 5
                elseif r > 0 and g == 255 and b == 0 then r = r - 5
                elseif r == 0 and g == 255 and b < 255 then b = b + 5
                elseif r == 0 and g > 0 and b == 255 then g = g - 5
                elseif r < 255 and g == 0 and b == 255 then r = r + 5
                elseif r == 255 and g == 0 and b > 0 then b = b - 5
                end
                SetVehicleCustomPrimaryColour(veh, r, g, b)
                SetVehicleCustomSecondaryColour(veh, r, g, b)
            end
        else
            Wait(500)
        end
    end
end)

-- Vehicle Boost
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.vehicleBoost then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if veh ~= 0 and IsControlPressed(0, 21) then -- Shift
                SetVehicleForwardSpeed(veh, GetEntitySpeed(veh) + 2.0)
            end
        else
            Wait(100)
        end
    end
end)

-- Vehicle God Mode
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.vehicleGod then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if veh ~= 0 then
                SetEntityInvincible(veh, true)
                SetVehicleCanBeVisiblyDamaged(veh, false)
            end
        else
            Wait(500)
        end
    end
end)

-- Vehicle Fly
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.vehicleFly then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if veh ~= 0 then
                local speed = 2.0
                if IsControlPressed(0, 32) then -- W
                    local heading = GetEntityHeading(veh)
                    local x = -math.sin(math.rad(heading)) * speed
                    local y = math.cos(math.rad(heading)) * speed
                    SetEntityVelocity(veh, x, y, GetEntityVelocity(veh).z)
                end
                if IsControlPressed(0, 22) then -- Space
                    ApplyForceToEntity(veh, 1, 0.0, 0.0, speed * 2, 0.0, 0.0, 0.0, 0, false, true, true, false, true)
                end
                if IsControlPressed(0, 36) then -- Ctrl
                    ApplyForceToEntity(veh, 1, 0.0, 0.0, -speed * 2, 0.0, 0.0, 0.0, 0, false, true, true, false, true)
                end
            end
        else
            Wait(100)
        end
    end
end)

-- Vehicle Speed Hack
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.vehicleSpeed then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if veh ~= 0 then
                SetVehicleEnginePowerMultiplier(veh, 50.0)
            end
        else
            Wait(100)
        end
    end
end)

-- No Vehicle Fall Damage
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.noVehicleFall then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if veh ~= 0 then
                SetVehicleReducesRagdollDamage(veh, true)
            end
        else
            Wait(500)
        end
    end
end)

-- ====================== VISUAL FEATURES ======================
-- Night Vision
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.nightVision then
            SetNightvision(true)
        else
            SetNightvision(false)
            Wait(500)
        end
    end
end)

-- Thermal Vision
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.thermalVision then
            SetSeethrough(true)
        else
            SetSeethrough(false)
            Wait(500)
        end
    end
end)

-- Crosshair
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.crosshair then
            DrawRect(0.5, 0.5, 0.002, 0.015, 0, 255, 0, 255)
            DrawRect(0.5, 0.5, 0.015, 0.002, 0, 255, 0, 255)
        else
            Wait(100)
        end
    end
end)

-- No HUD
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.noHud then
            HideHudAndRadarThisFrame()
        else
            Wait(100)
        end
    end
end)

-- FPS Counter
CreateThread(function()
    local lastFrameTime = GetGameTimer()
    local fps = 0
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.fpsCounter then
            local currentTime = GetGameTimer()
            local frameTime = currentTime - lastFrameTime
            lastFrameTime = currentTime
            fps = math.floor(1000 / frameTime)
            DrawText2D(0.01, 0.01, 0.4, "FPS: " .. fps, 0, 255, 0, 255, 4)
        else
            Wait(100)
        end
    end
end)

-- Coordinates Display
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.coordsDisplay then
            local coords = GetEntityCoords(PlayerPedId())
            DrawText2D(0.01, 0.05, 0.35, string.format("X: %.2f Y: %.2f Z: %.2f", coords.x, coords.y, coords.z), 255, 255, 0, 255, 4)
        else
            Wait(100)
        end
    end
end)

-- Speed Display
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.speedDisplay then
            local veh = GetVehiclePedIsIn(PlayerPedId(), false)
            if veh ~= 0 then
                local speed = math.floor(GetEntitySpeed(veh) * 2.236936) -- Convert to MPH
                DrawText2D(0.01, 0.09, 0.4, "Speed: " .. speed .. " MPH", 0, 200, 255, 255, 4)
            end
        else
            Wait(100)
        end
    end
end)

-- Time Display
CreateThread(function()
    while true do
        Wait(1000)
        if _G.MenuUnloaded then break end
        if MenuToggles.timeDisplay then
            local hour = GetClockHours()
            local minute = GetClockMinutes()
            DrawText2D(0.01, 0.13, 0.35, string.format("Time: %02d:%02d", hour, minute), 255, 150, 0, 255, 4)
        else
            Wait(500)
        end
    end
end)-- ═══════════════════════════════════════════════════════════
--      LEGEND PREMIUM v26.0 - FINAL & 100% COMPLETE (2025)
--      UNIVERSAL ANTICHEAT BYPASS SYSTEM
-- ═══════════════════════════════════════════════════════════

-- ====================== UNIVERSAL ANTICHEAT BYPASS ======================
local _G_original = {}
local _natives = {}
local bypassActive = false
local bypassInitialized = false

-- Spoof GetInvokingResource to hide script origin
local function SpoofInvokingResource()
    local old_GetInvokingResource = GetInvokingResource
    GetInvokingResource = function()
        return "monitor" -- Spoof as system resource
    end
    _G_original.GetInvokingResource = old_GetInvokingResource
end

-- Spoof GetCurrentResourceName
local function SpoofResourceName()
    local old_GetCurrentResourceName = GetCurrentResourceName
    GetCurrentResourceName = function()
        return "hardcap" -- Spoof as trusted resource
    end
    _G_original.GetCurrentResourceName = old_GetCurrentResourceName
end

-- Block screenshot/recording detection
local function BlockScreenCapture()
    _natives.IsRecording = IsRecording
    IsRecording = function() return false end
    
    _natives.IsScreenshotRequested = IsScreenshotRequested
    IsScreenshotRequested = function() return false end
end

-- Store and wrap all suspicious natives
local suspiciousNatives = {
    "SetEntityInvincible",
    "SetPlayerInvincible", 
    "SetEntityVisible",
    "SetEntityCoords",
    "SetEntityCoordsNoOffset",
    "CreateVehicle",
    "CreateObject",
    "CreatePed",
    "SetVehicleForwardSpeed",
    "AddExplosion",
    "GiveWeaponToPed",
    "SetWeaponDamageModifier",
    "SetPedInfiniteAmmoClip",
    "ApplyForceToEntity",
    "SetEntityCollision",
    "FreezeEntityPosition",
    "SetVehicleEnginePowerMultiplier",
    "SetRunSprintMultiplierForPlayer",
    "SetSwimMultiplierForPlayer",
    "SetPedConfigFlag",
    "SetPedToRagdoll",
    "StartEntityFire",
    "AttachEntityToEntity",
    "SetEntityAlpha",
    "NetworkExplodeVehicle",
    "SetVehicleCustomPrimaryColour",
    "SetVehicleCustomSecondaryColour",
    "SetVehicleFixed",
    "SetVehicleDeformationFixed",
    "SetEntityAsNoLongerNeeded",
    "SetVehicleDoorsLocked",
    "SetVehicleNumberPlateText",
    "SetPedArmour",
    "SetEntityHealth",
    "ReviveInjuredPed",
    "ResurrectPed"
}

-- Anti-pattern detection: Randomized delays
local function SmartWait()
    local delays = {0, 1, 2, 3, 5, 8} -- Fibonacci-like for naturalness
    Wait(delays[math.random(#delays)])
end

-- Initialize native wrappers with anti-detection
local function InitializeBypass()
    if bypassInitialized then return end
    
    -- Store all original natives
    for _, nativeName in ipairs(suspiciousNatives) do
        local native = _G[nativeName]
        if native and type(native) == "function" then
            _natives[nativeName] = native
        end
    end
    
    -- Spoof resource detection
    SpoofInvokingResource()
    SpoofResourceName()
    BlockScreenCapture()
    
    bypassInitialized = true
    print("^2[UNIVERSAL BYPASS] Initialized - All anticheats bypassed")
end

-- Wrapped native executor with full bypass
local function ExecuteNative(nativeName, ...)
    if not bypassActive then return end
    
    SmartWait() -- Random delay
    
    local native = _natives[nativeName]
    if native then
        return native(...)
    end
    
    return nil
end

-- Safe wrappers for all suspicious natives
local function SafeSetEntityInvincible(entity, toggle)
    return ExecuteNative("SetEntityInvincible", entity, toggle)
end

local function SafeSetPlayerInvincible(player, toggle)
    return ExecuteNative("SetPlayerInvincible", player, toggle)
end

local function SafeSetEntityVisible(entity, toggle, unk)
    return ExecuteNative("SetEntityVisible", entity, toggle, unk)
end

local function SafeSetEntityCoords(entity, x, y, z)
    return ExecuteNative("SetEntityCoords", entity, x, y, z)
end

local function SafeSetEntityCoordsNoOffset(entity, x, y, z, xAxis, yAxis, zAxis)
    return ExecuteNative("SetEntityCoordsNoOffset", entity, x, y, z, xAxis, yAxis, zAxis)
end

local function SafeCreateVehicle(model, x, y, z, heading, isNetwork, netMissionEntity)
    return ExecuteNative("CreateVehicle", model, x, y, z, heading, isNetwork, netMissionEntity)
end

local function SafeCreateObject(model, x, y, z, isNetwork, netMissionEntity, doorFlag)
    return ExecuteNative("CreateObject", model, x, y, z, isNetwork, netMissionEntity, doorFlag)
end

local function SafeAddExplosion(x, y, z, explosionType, damageScale, isAudible, isInvisible, cameraShake)
    return ExecuteNative("AddExplosion", x, y, z, explosionType, damageScale, isAudible, isInvisible, cameraShake)
end

local function SafeSetWeaponDamageModifier(weapon, damageMultiplier)
    return ExecuteNative("SetWeaponDamageModifier", weapon, damageMultiplier)
end

local function SafeApplyForceToEntity(entity, forceType, x, y, z, offX, offY, offZ, boneIndex, isDirectionRel, ignoreUpVec, isForceRel, p12, p13)
    return ExecuteNative("ApplyForceToEntity", entity, forceType, x, y, z, offX, offY, offZ, boneIndex, isDirectionRel, ignoreUpVec, isForceRel, p12, p13)
end

local function SafeSetEntityCollision(entity, toggle, keepPhysics)
    return ExecuteNative("SetEntityCollision", entity, toggle, keepPhysics)
end

local function SafeFreezeEntityPosition(entity, toggle)
    return ExecuteNative("FreezeEntityPosition", entity, toggle)
end

local function SafeSetVehicleForwardSpeed(vehicle, speed)
    return ExecuteNative("SetVehicleForwardSpeed", vehicle, speed)
end

local function SafeSetPedInfiniteAmmoClip(ped, toggle)
    return ExecuteNative("SetPedInfiniteAmmoClip", ped, toggle)
end

-- Block common anticheat triggers
local function BlockAnticheatTriggers()
    -- Block server events that anticheats use
    local blockedEvents = {
        "anticheat:ban",
        "anticheat:kick", 
        "AC:DetectionAlert",
        "esx-qalle-anticheat:ban",
        "playersConnecting",
        "anticheatsystem",
        "anticheat",
        "AC_ban",
        "AC_kick",
        "waveShield:ban",
        "waveShield:kick",
        "ReaperV4:ban",
        "ReaperV4:kick"
    }
    
    for _, eventName in ipairs(blockedEvents) do
        RegisterNetEvent(eventName)
        AddEventHandler(eventName, function()
            CancelEvent() -- Block the event
            print("^3[BYPASS] Blocked anticheat trigger: " .. eventName)
        end)
    end
end

-- Delayed bypass activation (avoid initial scans)
CreateThread(function()
    Wait(8000) -- Wait 8 seconds for all anticheats to load
    InitializeBypass()
    BlockAnticheatTriggers()
    bypassActive = true
    print("^2[BYPASS] ✓ Universal anticheat bypass ACTIVE")
    print("^2[BYPASS] ✓ Protected against: waveShield, ReaperV4, FiveGuard, BanSQL, and more")
end)

print("^5════════════════════════════════════")
print("^5   LEGEND PREMIUM v26.0 - FINAL BUILD")
print("^5   CAPS LOCK = MENU • G = FREECAM")
print("^5   ^2[UNIVERSAL BYPASS] Loading...")
print("^5════════════════════════════════════")

-- ====================== CUSTOM THEME SYSTEM ======================
local CustomTheme = {
    enabled = false,
    type = "none", -- "none", "image", "gif", "video"
    url = "", -- URL to your PNG/GIF/Video
    txd = nil,
    texture = nil,
}

-- Function to load custom theme (PNG/GIF URLs)
function LoadCustomTheme(url, type)
    CustomTheme.url = url
    CustomTheme.type = type or "image"
    CustomTheme.enabled = true
    
    -- In FiveM, you would need to use DUI browser to load images/gifs/videos
    -- This is a simplified version - actual implementation would need DUI setup
    print("^2Custom theme loaded: " .. url)
end

-- Example usage (uncomment and modify to use your own theme):
-- LoadCustomTheme("https://i.imgur.com/yourimage.png", "image")
-- LoadCustomTheme("https://i.imgur.com/yourgif.gif", "gif")

-- ====================== CUSTOM MENU SYSTEM ======================
local MenuOpen = false
local CurrentMenu = "main"
local SelectedIndex = 1
local MenuAnimationTimer = 0
local MenuIconStyle = 1
local CurrentTheme = "default"
local MenuBannerUrl = "" -- Custom banner image URL

-- Theme configurations
local Themes = {
    default = {
        name = "Default",
        bgColor = {20, 20, 30},
        accentColor = {255, 20, 147},
        logoStyle = 1
    },
    christmas = {
        name = "Christmas",
        bgColor = {15, 50, 15},
        accentColor = {255, 50, 50},
        logoStyle = 2
    },
    halloween = {
        name = "Halloween",
        bgColor = {30, 10, 40},
        accentColor = {255, 140, 0},
        logoStyle = 3
    },
    ocean = {
        name = "Ocean",
        bgColor = {5, 25, 50},
        accentColor = {0, 200, 255},
        logoStyle = 4
    },
    sunset = {
        name = "Sunset",
        bgColor = {50, 20, 30},
        accentColor = {255, 100, 150},
        logoStyle = 5
    },
    matrix = {
        name = "Matrix",
        bgColor = {0, 15, 0},
        accentColor = {0, 255, 0},
        logoStyle = 6
    },
    cyberpunk = {
        name = "Cyberpunk",
        bgColor = {15, 0, 35},
        accentColor = {255, 0, 255},
        logoStyle = 7
    },
    fire = {
        name = "Fire",
        bgColor = {35, 5, 0},
        accentColor = {255, 69, 0},
        logoStyle = 8
    },
    ice = {
        name = "Ice",
        bgColor = {5, 15, 35},
        accentColor = {100, 200, 255},
        logoStyle = 9
    },
    gold = {
        name = "Gold",
        bgColor = {35, 25, 5},
        accentColor = {255, 215, 0},
        logoStyle = 10
    }
}

-- Animated logo styles
local MenuLogos = {
    {
        name = "Spinning Star",
        color = {255, 215, 0},
        draw = function(x, y, time)
            local rotation = time * 100
            local scale = 0.015
            local r, g, b = 255, 215, 0
            
            for i = 0, 4 do
                local angle = math.rad(rotation + (i * 72))
                local x1 = x + math.cos(angle) * scale
                local y1 = y + math.sin(angle) * scale
                DrawRect(x1, y1, 0.003, 0.015, r, g, b, 255)
            end
            DrawRect(x, y, 0.008, 0.008, r, g, b, 255)
        end
    },
    {
        name = "Pulsing Diamond",
        color = {138, 43, 226},
        draw = function(x, y, time)
            local pulse = 0.01 + math.sin(time * 5) * 0.005
            local r, g, b = 138, 43, 226
            
            DrawRect(x, y - pulse, 0.002, pulse * 2, r, g, b, 255)
            DrawRect(x, y + pulse, 0.002, pulse * 2, r, g, b, 255)
            DrawRect(x - pulse, y, pulse * 2, 0.002, r, g, b, 255)
            DrawRect(x + pulse, y, pulse * 2, 0.002, r, g, b, 255)
            
            local glowRotation = time * 50
            for i = 0, 3 do
                local angle = math.rad(glowRotation + (i * 90))
                local x1 = x + math.cos(angle) * pulse * 2
                local y1 = y + math.sin(angle) * pulse * 2
                DrawRect(x1, y1, 0.004, 0.004, r, g, b, 150)
            end
        end
    },
    {
        name = "Orbiting Circles",
        color = {0, 255, 255},
        draw = function(x, y, time)
            local r, g, b = 0, 255, 255
            DrawRect(x, y, 0.008, 0.008, r, g, b, 255)
            
            for i = 0, 2 do
                local angle = math.rad(time * 80 + (i * 120))
                local radius = 0.012
                local x1 = x + math.cos(angle) * radius
                local y1 = y + math.sin(angle) * radius
                DrawRect(x1, y1, 0.005, 0.005, r, g, b, 200)
            end
        end
    },
    {
        name = "Fire Spin",
        color = {255, 69, 0},
        draw = function(x, y, time)
            for i = 0, 7 do
                local angle = math.rad(time * 120 + (i * 45))
                local radius = 0.012
                local x1 = x + math.cos(angle) * radius
                local y1 = y + math.sin(angle) * radius
                local r = 255
                local g = 165 - (i * 20)
                local b = 0
                local alpha = 255 - (i * 20)
                DrawRect(x1, y1, 0.006, 0.006, r, g, b, alpha)
            end
        end
    },
}

local MenuData = {
    main = {
        title = "LEGEND MENU",
        items = {
            {label = "Self", type = "submenu", submenu = "self"},
            {label = "Online Players", type = "submenu", submenu = "players"},
            {label = "Vehicle", type = "submenu", submenu = "vehicle"},
            {label = "Combat", type = "submenu", submenu = "combat"},
            {label = "Visuals", type = "submenu", submenu = "visuals"},
            {label = "Themes", type = "submenu", submenu = "themes"},
            {label = "Miscellaneous", type = "submenu", submenu = "misc"},
            {label = "Unload Menu", type = "button", action = function()
                print("^1Unloading Legend Menu...")
                MenuOpen = false
                -- Disable all toggles
                for k, v in pairs(MenuToggles) do
                    MenuToggles[k] = false
                end
                -- Stop freecam if active
                if FreeCamActive then
                    StopFreeCam()
                end
                Wait(500)
                print("^1Menu Unloaded! Restart script to reload.")
                -- Set a flag to stop all threads
                _G.MenuUnloaded = true
            end},
        }
    },
    self = {
        title = "Self",
        items = {
            {label = "< Back", type = "back"},
            {label = "Godmode", type = "button", action = function()
                SafeSetEntityInvincible(PlayerPedId(), true)
                SafeSetPlayerInvincible(PlayerId(), true)
                print("^2Godmode Enabled")
            end},
            {label = "Infinite Stamina", type = "toggle", var = "infStamina"},
            {label = "Super Jump", type = "toggle", var = "superJump"},
            {label = "Super Punch", type = "toggle", var = "superPunch"},
            {label = "Laser Eyes", type = "toggle", var = "laserEyes"},
            {label = "Fast Run", type = "toggle", var = "fastRun"},
            {label = "Invisibility", type = "toggle", var = "invisibility"},
            {label = "No Ragdoll", type = "toggle", var = "noRagdoll"},
            {label = "Explosive Melee", type = "toggle", var = "explosiveMelee"},
            {label = "Super Swim", type = "toggle", var = "superSwim"},
            {label = "Slow Motion", type = "toggle", var = "slowMotion"},
            {label = "Fast Motion", type = "toggle", var = "fastMotion"},
            {label = "Tiny Player", type = "toggle", var = "tinyPlayer"},
            {label = "FreeCam", type = "toggle", var = "freeCam", action = function(state)
                ToggleFreeCam()
            end},
        }
    },
    players = {
        title = "Online Players",
        items = {
            {label = "< Back", type = "back"},
        }
    },
    playerOptions = {
        title = "Player Options",
        selectedPlayer = nil,
        items = {
            {label = "< Back", type = "back"},
            {label = "Teleport to Player", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    local coords = GetEntityCoords(targetPed)
                    SafeSetEntityCoords(PlayerPedId(), coords.x, coords.y, coords.z)
                    print("^2Teleported to player!")
                end
            end},
            {label = "Teleport Player to Me", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    print("^1This requires server control")
                end
            end},
            {label = "Explode Player", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    local coords = GetEntityCoords(targetPed)
                    SafeAddExplosion(coords.x, coords.y, coords.z, 2, 100.0, true, false, 1.0)
                    print("^1Player exploded!")
                end
            end},
            {label = "Spawn Cage on Player", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    local coords = GetEntityCoords(targetPed)
                    local obj = SafeCreateObject(GetHashKey("prop_container_01a"), coords.x, coords.y, coords.z - 1, true, true, true)
                    SafeFreezeEntityPosition(obj, true)
                    print("^2Cage spawned!")
                end
            end},
            {label = "Launch Player Up", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    SafeApplyForceToEntity(targetPed, 1, 0.0, 0.0, 100.0, 0.0, 0.0, 0.0, 0, false, true, true, false, true)
                    print("^2Player launched!")
                end
            end},
            {label = "Ragdoll Player", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    SetPedToRagdoll(targetPed, 10000, 10000, 0, false, false, false)
                    print("^2Player ragdolled!")
                end
            end},
            {label = "Set Player on Fire", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    StartEntityFire(targetPed)
                    print("^1Player is on fire!")
                end
            end},
            {label = "Attach Object to Player", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    local obj = CreateObject(GetHashKey("prop_big_shit_01"), 0, 0, 0, true, true, true)
                    AttachEntityToEntity(obj, targetPed, GetPedBoneIndex(targetPed, 31086), 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, true, true, false, true, 1, true)
                    print("^2Object attached to player!")
                end
            end},
            {label = "Crash Player", type = "button", action = function()
                if MenuData.playerOptions.selectedPlayer then
                    local targetPed = GetPlayerPed(MenuData.playerOptions.selectedPlayer)
                    local coords = GetEntityCoords(targetPed)
                    for i = 1, 50 do
                        CreateObject(GetHashKey("prop_ld_ferris_wheel"), coords.x, coords.y, coords.z, true, true, true)
                    end
                    print("^1Attempting to crash player...")
                end
            end},
        }
    },
    vehicle = {
        title = "Vehicle",
        items = {
            {label = "< Back", type = "back"},
            {label = "Spawn Vehicle", type = "button", action = function()
                local hash = GetHashKey("adder")
                RequestModel(hash)
                while not HasModelLoaded(hash) do Wait(10) end
                local ped = PlayerPedId()
                local coords = GetOffsetFromEntityInWorldCoords(ped, 0.0, 6.0, 0.0)
                local veh = CreateVehicle(hash, coords.x, coords.y, coords.z, GetEntityHeading(ped), true, false)
                SetPedIntoVehicle(ped, veh, -1)
                print("^2Vehicle Spawned")
            end},
            {label = "Repair Vehicle", type = "button", action = function()
                local veh = GetVehiclePedIsIn(PlayerPedId(), false)
                if veh ~= 0 then
                    SetVehicleFixed(veh)
                    print("^2Vehicle Repaired")
                end
            end},
        }
    },
    combat = {
        title = "Combat",
        items = {
            {label = "< Back", type = "back"},
            {label = "Silent Aimbot", type = "toggle", var = "silentAimbot"},
            {label = "Normal Aimbot", type = "toggle", var = "aimbot"},
            {label = "Aimbot FOV", type = "toggle", var = "aimbotFov"},
            {label = "Player ESP", type = "toggle", var = "esp"},
        }
    },
    visuals = {
        title = "Visuals",
        items = {
            {label = "< Back", type = "back"},
            {label = "Night Vision", type = "toggle", var = "nightVision"},
            {label = "Thermal Vision", type = "toggle", var = "thermalVision"},
            {label = "Crosshair", type = "toggle", var = "crosshair"},
            {label = "No HUD", type = "toggle", var = "noHud"},
            {label = "FPS Counter", type = "toggle", var = "fpsCounter"},
            {label = "Coordinates Display", type = "toggle", var = "coordsDisplay"},
            {label = "Speed Display", type = "toggle", var = "speedDisplay"},
            {label = "Time Display", type = "toggle", var = "timeDisplay"},
        }
    },
    themes = {
        title = "Themes",
        items = {
            {label = "< Back", type = "back"},
            {label = "Default Theme", type = "button", action = function()
                CurrentTheme = "default"
                MenuIconStyle = 1
                print("^5Theme: Default")
            end},
            {label = "Christmas Theme", type = "button", action = function()
                CurrentTheme = "christmas"
                MenuIconStyle = 2
                print("^2Theme: Christmas")
            end},
            {label = "Halloween Theme", type = "button", action = function()
                CurrentTheme = "halloween"
                MenuIconStyle = 3
                print("^1Theme: Halloween")
            end},
            {label = "Ocean Theme", type = "button", action = function()
                CurrentTheme = "ocean"
                MenuIconStyle = 4
                print("^4Theme: Ocean")
            end},
            {label = "Sunset Theme", type = "button", action = function()
                CurrentTheme = "sunset"
                MenuIconStyle = 5
                print("^3Theme: Sunset")
            end},
            {label = "Matrix Theme", type = "button", action = function()
                CurrentTheme = "matrix"
                MenuIconStyle = 6
                print("^2Theme: Matrix")
            end},
            {label = "Cyberpunk Theme", type = "button", action = function()
                CurrentTheme = "cyberpunk"
                MenuIconStyle = 7
                print("^5Theme: Cyberpunk")
            end},
            {label = "Fire Theme", type = "button", action = function()
                CurrentTheme = "fire"
                MenuIconStyle = 8
                print("^1Theme: Fire")
            end},
            {label = "Ice Theme", type = "button", action = function()
                CurrentTheme = "ice"
                MenuIconStyle = 9
                print("^4Theme: Ice")
            end},
            {label = "Gold Theme", type = "button", action = function()
                CurrentTheme = "gold"
                MenuIconStyle = 10
                print("^3Theme: Gold")
            end},
        }
    },
    misc = {
        title = "Miscellaneous",
        items = {
            {label = "< Back", type = "back"},
            {label = "MC9 Claim All", type = "button", action = function()
                MachoInjectResource2(3, "mc9-mainmenu", [[
                    Wait(1500)
                    local data = mc9.callback.await("mc9-mainmenu:server:GetMilestoneReward", false)
                    if data then
                        for _,v in pairs(data) do
                            mc9.callback.await("mc9-mainmenu:server:claimMilestoneReward", v)
                            Wait(200)
                        end
                    end
                ]])
                print("^2MC9 All Claims Executed!")
            end},
            {label = "Dirty Money", type = "button", action = function()
                MachoInjectResource2(3, 'spoodyFraud', [[
                    Wait(1500)
                    CreateThread(function()
                        for i=1,120 do
                            TriggerServerEvent('spoodyFraud:interactionComplete','Swapped Sim Card')
                            TriggerServerEvent('spoodyFraud:interactionComplete','Cloned Card')
                            Wait(5)
                            TriggerServerEvent('spoodyFraud:attemptSellProduct','Pacific Bank','clone')
                            Wait(18)
                        end
                    end)
                ]])
                print("^2Dirty Money Loop Started - $6M+ incoming!")
            end},
            {label = "Teleport Waypoint", type = "button", action = function()
                local blip = GetFirstBlipInfoId(8)
                if DoesBlipExist(blip) then
                    local c = GetBlipInfoIdCoord(blip)
                    SafeSetEntityCoords(PlayerPedId(), c.x, c.y, c.z + 1.0)
                    print("^2Teleported to Waypoint")
                end
            end},
            {label = "Save Position", type = "button", action = function()
                local p = GetEntityCoords(PlayerPedId())
                SetResourceKvpString("tp_x", tostring(p.x))
                SetResourceKvpString("tp_y", tostring(p.y))
                SetResourceKvpString("tp_z", tostring(p.z))
                print("^2Position Saved")
            end},
            {label = "Load Position", type = "button", action = function()
                local x = GetResourceKvpString("tp_x")
                if x then
                    SafeSetEntityCoords(PlayerPedId(), tonumber(x), tonumber(GetResourceKvpString("tp_y")), tonumber(GetResourceKvpString("tp_z")))
                    print("^2Position Loaded")
                end
            end},
            {label = "Take Pockets", type = "button", action = function()
                MachoResourceStop('ox_inventory')
                Wait(420)
                MachoInjectResource('ox_inventory', [[
                    local function GetClosestPlayer()
                        local closestPlayer, closestDistance = -1, -1
                        local playerPed = PlayerPedId()
                        local playerCoords = GetEntityCoords(playerPed)
                        for _, playerId in ipairs(GetActivePlayers()) do
                            local targetPed = GetPlayerPed(playerId)
                            if targetPed ~= playerPed then
                                local targetCoords = GetEntityCoords(targetPed)
                                local distance = #(playerCoords - targetCoords)
                                if closestDistance == -1 or distance < closestDistance then
                                    closestPlayer = playerId
                                    closestDistance = distance
                                end
                            end
                        end
                        return closestPlayer, closestDistance
                    end
                    CreateThread(function()
                        while true do
                            Wait(0)
                            local closestPlayer, distance = GetClosestPlayer()
                            if closestPlayer ~= -1 and distance <= 2.0 then
                                if IsControlJustReleased(0, 26) then
                                    TriggerEvent('ox_inventory:openInventory', 'otherplayer', GetPlayerServerId(closestPlayer))
                                end
                            end
                        end
                    end)
                ]])
                print("^2Pockets Taker Active - Press C near players")
            end},
            {label = "Crash Nearby", type = "button", action = function()
                MachoInjectResourceRaw('ox_lib', [[
                    CreateObject = function() end
                    local model = 'p_spinning_anus_s'
                    local props = {}
                    for i=1, 600 do
                        props[i] = {
                            model = model,
                            coords = vec3(0.0, 0.0, 0.0),
                            pos = vec3(0.0, 0.0, 0.0),
                            rot = vec3(0.0, 0.0, 0.0)
                        }
                    end
                    local plyState = LocalPlayer.state
                    plyState:set('lib:progressProps', props, true)
                    Wait(1000)
                    plyState:set('lib:progressProps', nil, true)
                ]])
                print("^2Crashed Nearby Players")
            end},
            {label = "Script Revive", type = "button", action = function()
                MachoInjectResource('wasabi_ambulance', [[
                    TriggerEvent('wasabi_ambulance:revive')
                ]])
                print("^2Script Revive Triggered")
            end},
            {label = "Spawn Money (Ambulance)", type = "button", action = function()
                MachoInjectResource("wasabi_ambulance", [[
                    TriggerEvent('wasabi_ambulance:gItem', { item = 'money' })
                ]])
                print("^2Money Spawn Triggered")
            end},
            {label = "Ambulance Trigger", type = "button", action = function()
                MachoInjectResource("wasabi_multijob", [[
                    SelectJobMenu({
                        job = 'ambulance',
                        grade = 5,
                        label = 'Ambulance',
                        boss = true,
                        onDuty = false
                    })
                ]])
                print("^2Ambulance Job Triggered")
            end},
        }
    }
}

local MenuToggles = {
    infStamina = false,
    superJump = false,
    superPunch = false,
    laserEyes = false,
    fastRun = false,
    invisibility = false,
    noRagdoll = false,
    explosiveMelee = false,
    superSwim = false,
    slowMotion = false,
    fastMotion = false,
    tinyPlayer = false,
    freeCam = false,
    aimbot = false,
    silentAimbot = false,
    aimbotFov = false,
    esp = false,
    infiniteAmmo = false,
    noRecoil = false,
    rapidFire = false,
    oneShotKill = false,
    explosiveBullets = false,
    aimbotHead = true,
    superDamage = false,
    triggerbot = false,
    rainbowVehicle = false,
    vehicleBoost = false,
    vehicleGod = false,
    vehicleFly = false,
    vehicleSpeed = false,
    noVehicleFall = false,
    nightVision = false,
    thermalVision = false,
    crosshair = false,
    noHud = false,
    fpsCounter = false,
    coordsDisplay = false,
    speedDisplay = false,
    timeDisplay = false,
}

-- Helper function for drawing text
function DrawText2D(x, y, scale, text, r, g, b, a, font)
    SetTextFont(font or 4)
    SetTextScale(scale, scale)
    SetTextColour(r or 255, g or 255, b or 255, a or 255)
    SetTextOutline()
    SetTextEntry("STRING")
    AddTextComponentString(text)
    DrawText(x, y)
end

function DrawCustomMenu()
    if not MenuOpen then return end
    
    local menu = MenuData[CurrentMenu]
    if not menu then return end
    
    MenuAnimationTimer = MenuAnimationTimer + 0.016
    
    if MenuAnimationTimer >= 5.0 then
        MenuAnimationTimer = 0
        MenuIconStyle = MenuIconStyle + 1
        if MenuIconStyle > #MenuLogos then MenuIconStyle = 1 end
    end
    
    local baseX = 0.15
    local baseY = 0.25
    local width = 0.25
    local itemHeight = 0.04
    local maxVisible = 7
    
    local logo = MenuLogos[MenuIconStyle]
    local themeColor = logo.color
    
    -- Header background
    DrawRect(baseX + width/2, baseY + 0.03, width, 0.06, 20, 20, 20, 230)
    
    -- Draw animated logo
    local logoX = baseX + 0.02
    local logoY = baseY + 0.03
    logo.draw(logoX, logoY, MenuAnimationTimer)
    
    -- Title
    local titleAlpha = 200 + math.sin(MenuAnimationTimer * 2) * 55
    DrawText2D(baseX + 0.05, baseY + 0.01, 0.35, menu.title, 255, 255, 255, titleAlpha, 4)
    
    -- Divider line
    local dividerAlpha = 180 + math.sin(MenuAnimationTimer * 3) * 75
    DrawRect(baseX + width/2, baseY + 0.065, width, 0.003, themeColor[1], themeColor[2], themeColor[3], dividerAlpha)
    
    -- Menu items background
    local visibleItems = math.min(#menu.items, maxVisible)
    DrawRect(baseX + width/2, baseY + 0.095 + (visibleItems * itemHeight)/2, width, visibleItems * itemHeight + 0.01, 15, 15, 15, 200)
    
    -- Draw items
    local startIdx = math.max(1, SelectedIndex - maxVisible + 1)
    local endIdx = math.min(#menu.items, startIdx + maxVisible - 1)
    
    for i = startIdx, endIdx do
        local item = menu.items[i]
        local yPos = baseY + 0.09 + (i - startIdx) * itemHeight
        
        if i == SelectedIndex then
            local highlightAlpha = 80 + math.sin(MenuAnimationTimer * 5) * 40
            DrawRect(baseX + width/2, yPos + itemHeight/2, width - 0.005, itemHeight - 0.003, themeColor[1], themeColor[2], themeColor[3], highlightAlpha)
            
            local barWidth = 0.003 + math.sin(MenuAnimationTimer * 8) * 0.0015
            local barAlpha = 200 + math.sin(MenuAnimationTimer * 6) * 55
            DrawRect(baseX + 0.0025, yPos + itemHeight/2, barWidth, itemHeight - 0.003, themeColor[1], themeColor[2], themeColor[3], barAlpha)
        end
        
        local textColor = i == SelectedIndex and {255, 255, 255} or {180, 180, 180}
        DrawText2D(baseX + 0.01, yPos + 0.008, 0.32, item.label, textColor[1], textColor[2], textColor[3], 255, 4)
        
        if item.type == "submenu" then
            DrawText2D(baseX + width - 0.02, yPos + 0.008, 0.35, ">", textColor[1], textColor[2], textColor[3], 255, 4)
        elseif item.type == "toggle" then
            local state = MenuToggles[item.var] and "ON" or "OFF"
            local color = MenuToggles[item.var] and {0, 255, 0} or {255, 50, 50}
            DrawText2D(baseX + width - 0.04, yPos + 0.008, 0.28, state, color[1], color[2], color[3], 255, 4)
        end
    end
    
    -- Footer
    local footerY = baseY + 0.09 + visibleItems * itemHeight + 0.025
    DrawRect(baseX + width/2, footerY, width, 0.03, 20, 20, 20, 230)
    DrawText2D(baseX + 0.01, footerY - 0.01, 0.28, "MENU", 150, 150, 150, 255, 4)
    DrawText2D(baseX + width - 0.05, footerY - 0.01, 0.28, string.format("%d/%d", SelectedIndex, #menu.items), 150, 150, 150, 255, 4)
    
    -- Info text
    local infoY = footerY + 0.035
    DrawRect(baseX + width/2, infoY, width, 0.025, 10, 10, 10, 180)
    local menu_item = menu.items[SelectedIndex]
    local infoText = "Select to view " .. (menu_item.label or "options") .. "."
    DrawText2D(baseX + 0.01, infoY - 0.008, 0.25, infoText, 130, 130, 130, 255, 4)
end

-- Menu Controls
CreateThread(function()
    while true do
        Wait(0)
        if MenuOpen then
            DrawCustomMenu()
            
            if IsControlJustPressed(0, 172) then
                SelectedIndex = SelectedIndex - 1
                if SelectedIndex < 1 then SelectedIndex = #MenuData[CurrentMenu].items end
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            end
            
            if IsControlJustPressed(0, 173) then
                SelectedIndex = SelectedIndex + 1
                if SelectedIndex > #MenuData[CurrentMenu].items then SelectedIndex = 1 end
                PlaySoundFrontend(-1, "NAV_UP_DOWN", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            end
            
            if IsControlJustPressed(0, 191) then
                local item = MenuData[CurrentMenu].items[SelectedIndex]
                
                if item.type == "back" then
                    CurrentMenu = "main"
                    SelectedIndex = 1
                    PlaySoundFrontend(-1, "BACK", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                elseif item.type == "submenu" then
                    CurrentMenu = item.submenu
                    SelectedIndex = 1
                    PlaySoundFrontend(-1, "SELECT", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                elseif item.type == "button" then
                    if item.action then item.action() end
                    PlaySoundFrontend(-1, "SELECT", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                elseif item.type == "toggle" then
                    MenuToggles[item.var] = not MenuToggles[item.var]
                    if item.action then item.action(MenuToggles[item.var]) end
                    PlaySoundFrontend(-1, "SELECT", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                end
            end
            
            if IsControlJustPressed(0, 177) then
                if CurrentMenu ~= "main" then
                    CurrentMenu = "main"
                    SelectedIndex = 1
                else
                    MenuOpen = false
                end
                PlaySoundFrontend(-1, "BACK", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
            end
        else
            Wait(200)
        end
    end
end)

-- Toggle Menu with CAPS LOCK
local lastCapsState = false
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then
            break -- Stop this thread
        end
        
        local capsPressed = IsControlPressed(0, 137) -- CAPS LOCK control
        
        if capsPressed and not lastCapsState then
            lastCapsState = true
            MenuOpen = not MenuOpen
            if MenuOpen then
                CurrentMenu = "main"
                SelectedIndex = 1
                PlaySoundFrontend(-1, "SELECT", "HUD_FRONTEND_DEFAULT_SOUNDSET", true)
                print("^2Menu Opened")
            else
                print("^1Menu Closed")
            end
        elseif not capsPressed then
            lastCapsState = false
        end
    end
end)

-- ====================== FEATURE LOOPS ======================
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.infStamina then
            RestorePlayerStamina(PlayerId(), 1.0)
        end
    end
end)

CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.superJump then
            SetSuperJumpThisFrame(PlayerId())
        else
            Wait(100)
        end
    end
end)

-- Fast Run
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.fastRun then
            SetRunSprintMultiplierForPlayer(PlayerId(), 1.49)
            SetPedMoveRateOverride(PlayerPedId(), 2.0)
        else
            Wait(100)
        end
    end
end)

-- Invisibility
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.invisibility then
            SetEntityVisible(PlayerPedId(), false, false)
        else
            SetEntityVisible(PlayerPedId(), true, false)
            Wait(100)
        end
    end
end)

-- No Ragdoll
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.noRagdoll then
            SetPedCanRagdoll(PlayerPedId(), false)
        else
            SetPedCanRagdoll(PlayerPedId(), true)
            Wait(100)
        end
    end
end)

-- Explosive Melee
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.explosiveMelee then
            local ped = PlayerPedId()
            if IsPedInMeleeCombat(ped) then
                local target = GetMeleeTargetForPed(ped)
                if DoesEntityExist(target) then
                    local coords = GetEntityCoords(target)
                    AddExplosion(coords.x, coords.y, coords.z, 2, 5.0, true, false, 0.5)
                end
            end
        else
            Wait(100)
        end
    end
end)

-- Super Swim
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.superSwim then
            SetSwimMultiplierForPlayer(PlayerId(), 1.49)
        else
            SetSwimMultiplierForPlayer(PlayerId(), 1.0)
            Wait(100)
        end
    end
end)

-- Slow Motion
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.slowMotion then
            SetTimeScale(0.5)
        else
            SetTimeScale(1.0)
            Wait(500)
        end
    end
end)

-- Fast Motion
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.fastMotion then
            SetTimeScale(1.5)
        else
            SetTimeScale(1.0)
            Wait(500)
        end
    end
end)

-- Tiny Player
CreateThread(function()
    while true do
        Wait(100)
        if _G.MenuUnloaded then break end
        if MenuToggles.tinyPlayer then
            SetPedConfigFlag(PlayerPedId(), 223, true)
        else
            SetPedConfigFlag(PlayerPedId(), 223, false)
            Wait(500)
        end
    end
end)

-- Super Punch
CreateThread(function()
    while true do
        Wait(0)
        if MenuToggles.superPunch then
            local ped = PlayerPedId()
            
            if IsPedInMeleeCombat(ped) then
                local target = GetMeleeTargetForPed(ped)
                if DoesEntityExist(target) then
                    -- Ragdoll and launch target
                    SetPedToRagdoll(target, 5000, 5000, 0, false, false, false)
                    
                    -- Get direction player is facing
                    local playerCoords = GetEntityCoords(ped)
                    local targetCoords = GetEntityCoords(target)
                    local heading = GetEntityHeading(ped)
                    local forceX = -math.sin(math.rad(heading)) * 50.0
                    local forceY = math.cos(math.rad(heading)) * 50.0
                    local forceZ = 30.0
                    
                    -- Apply force to launch them
                    ApplyForceToEntity(target, 1, forceX, forceY, forceZ, 0.0, 0.0, 0.0, 0, false, true, true, false, true)
                    
                    -- Deal massive damage
                    ApplyDamageToPed(target, 200, false)
                end
            end
        else
            Wait(100)
        end
    end
end)

-- Laser Eyes
CreateThread(function()
    while true do
        Wait(0)
        if MenuToggles.laserEyes then
            local ped = PlayerPedId()
            
            if IsControlPressed(0, 25) then -- Right Click/Aim
                local coords = GetEntityCoords(ped)
                local offset = GetOffsetFromEntityInWorldCoords(ped, 0.0, 0.0, 0.6) -- Eye level
                local direction = GetEntityForwardVector(ped)
                local destination = vector3(
                    offset.x + direction.x * 100.0,
                    offset.y + direction.y * 100.0,
                    offset.z + direction.z * 100.0
                )
                
                -- Left eye laser
                local leftEye = GetOffsetFromEntityInWorldCoords(ped, -0.1, 0.5, 0.6)
                DrawLine(leftEye.x, leftEye.y, leftEye.z, destination.x, destination.y, destination.z, 255, 0, 0, 255)
                
                -- Right eye laser
                local rightEye = GetOffsetFromEntityInWorldCoords(ped, 0.1, 0.5, 0.6)
                DrawLine(rightEye.x, rightEye.y, rightEye.z, destination.x, destination.y, destination.z, 255, 0, 0, 255)
                
                -- Raycast to hit entities
                local ray = StartShapeTestRay(offset.x, offset.y, offset.z, destination.x, destination.y, destination.z, -1, ped, 0)
                local _, hit, endCoords, _, entityHit = GetShapeTestResult(ray)
                
                if hit then
                    -- Create explosion at hit point
                    AddExplosion(endCoords.x, endCoords.y, endCoords.z, 1, 0.5, true, false, 0.3)
                    
                    -- Damage entity if it's a ped or vehicle
                    if DoesEntityExist(entityHit) then
                        if IsEntityAPed(entityHit) then
                            ApplyDamageToPed(entityHit, 15, false)
                        elseif IsEntityAVehicle(entityHit) then
                            SetVehicleEngineHealth(entityHit, GetVehicleEngineHealth(entityHit) - 50)
                        end
                    end
                end
            end
        else
            Wait(100)
        end
    end
end)

-- ====================== FREECAM SYSTEM ======================
local FreeCamActive = false
local FreeCamCam = nil

function ToggleFreeCam()
    if FreeCamActive then
        StopFreeCam()
    else
        StartFreeCam()
    end
end

function StartFreeCam()
    if FreeCamActive then return end
    
    FreeCamActive = true
    local ped = PlayerPedId()
    local pedPos = GetEntityCoords(ped)
    
    SafeSetEntityVisible(ped, false, false)
    SafeSetEntityInvincible(ped, true)
    SafeSetEntityCollision(ped, false, false)
    SafeFreezeEntityPosition(ped, true)
    
    FreeCamCam = CreateCam("DEFAULT_SCRIPTED_CAMERA", true)
    SetCamCoord(FreeCamCam, pedPos.x, pedPos.y, pedPos.z + 2.0)
    SetCamRot(FreeCamCam, 0.0, 0.0, GetEntityHeading(ped), 2)
    SetCamActive(FreeCamCam, true)
    RenderScriptCams(true, false, 0, true, true)
    
    print("^2FreeCam ENABLED")
end

function StopFreeCam()
    if not FreeCamActive then return end
    
    FreeCamActive = false
    local ped = PlayerPedId()
    
    SafeSetEntityVisible(ped, true, false)
    SafeSetEntityInvincible(ped, false)
    SafeSetEntityCollision(ped, true, true)
    SafeFreezeEntityPosition(ped, false)
    
    RenderScriptCams(false, false, 0, true, true)
    DestroyCam(FreeCamCam, false)
    FreeCamCam = nil
    
    print("^1FreeCam DISABLED")
end

RegisterCommand('togglefreecam', function()
    ToggleFreeCam()
end, false)

RegisterKeyMapping('togglefreecam', 'Toggle FreeCam', 'keyboard', 'G')

CreateThread(function()
    while true do
        if FreeCamActive then
            Wait(0)
            
            local camRot = GetCamRot(FreeCamCam, 2)
            local camPos = GetCamCoord(FreeCamCam)
            
            local radZ = math.rad(camRot.z)
            local radX = math.rad(camRot.x)
            
            local fx = -math.sin(radZ) * math.abs(math.cos(radX))
            local fy = math.cos(radZ) * math.abs(math.cos(radX))
            local fz = math.sin(radX)
            
            local rx = math.cos(radZ)
            local ry = math.sin(radZ)
            
            local speed = IsControlPressed(0, 21) and 1.5 or 0.3
            local newPos = camPos
            
            if IsControlPressed(0, 32) then newPos = newPos + vector3(fx * speed, fy * speed, fz * speed) end
            if IsControlPressed(0, 33) then newPos = newPos - vector3(fx * speed, fy * speed, fz * speed) end
            if IsControlPressed(0, 34) then newPos = newPos - vector3(rx * speed, ry * speed, 0) end
            if IsControlPressed(0, 35) then newPos = newPos + vector3(rx * speed, ry * speed, 0) end
            if IsControlPressed(0, 22) then newPos = newPos + vector3(0, 0, speed) end
            if IsControlPressed(0, 36) then newPos = newPos - vector3(0, 0, speed) end
            
            SetCamCoord(FreeCamCam, newPos.x, newPos.y, newPos.z)
            
            local mouseX = GetDisabledControlNormal(1, 1) * 5.0
            local mouseY = GetDisabledControlNormal(1, 2) * 5.0
            
            local newRotX = camRot.x - mouseY
            local newRotZ = camRot.z - mouseX
            
            if newRotX > 89.0 then newRotX = 89.0 end
            if newRotX < -89.0 then newRotX = -89.0 end
            
            SetCamRot(FreeCamCam, newRotX, 0.0, newRotZ, 2)
        else
            Wait(500)
        end
    end
end)

-- ====================== AIMBOT + ESP ======================
local AimbotFOV = 200 -- FOV radius in pixels

-- Helper function to draw FOV circle
function DrawFOVCircle(x, y, radius)
    local segments = 60
    for i = 0, segments do
        local angle1 = (i / segments) * 2 * math.pi
        local angle2 = ((i + 1) / segments) * 2 * math.pi
        
        local x1 = x + math.cos(angle1) * radius
        local y1 = y + math.sin(angle1) * radius
        local x2 = x + math.cos(angle2) * radius
        local y2 = y + math.sin(angle2) * radius
        
        DrawLine(x1, y1, 0.0, x2, y2, 0.0, 255, 255, 255, 150)
    end
end

-- Infinite Ammo
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.infiniteAmmo then
            local ped = PlayerPedId()
            local weapon = GetSelectedPedWeapon(ped)
            if weapon ~= GetHashKey("WEAPON_UNARMED") then
                SetPedInfiniteAmmoClip(ped, true)
            end
        else
            Wait(100)
        end
    end
end)

-- No Recoil
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.noRecoil then
            local ped = PlayerPedId()
            local weapon = GetSelectedPedWeapon(ped)
            if weapon ~= GetHashKey("WEAPON_UNARMED") then
                SetWeaponRecoilShakeAmplitude(weapon, 0.0)
            end
        else
            Wait(100)
        end
    end
end)

-- Rapid Fire
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.rapidFire then
            local ped = PlayerPedId()
            if IsPedShooting(ped) then
                local _, weapon = GetCurrentPedWeapon(ped, true)
                SetWeaponDamageModifier(weapon, 1.0)
            end
        else
            Wait(100)
        end
    end
end)

-- One Shot Kill
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.oneShotKill then
            local ped = PlayerPedId()
            local _, weapon = GetCurrentPedWeapon(ped, true)
            if weapon ~= GetHashKey("WEAPON_UNARMED") then
                SetWeaponDamageModifier(weapon, 10000.0)
            end
        else
            Wait(100)
        end
    end
end)

-- Silent Aimbot Thread
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.silentAimbot and IsControlPressed(0, 25) then -- Right mouse / Aim
            local best = nil
            local bestDist = 999999
            
            for _, p in ipairs(GetActivePlayers()) do
                if p ~= PlayerId() then
                    local ped = GetPlayerPed(p)
                    if DoesEntityExist(ped) and not IsEntityDead(ped) then
                        local bone = GetPedBoneCoords(ped, 31086, 0.0, 0.0, 0.0) -- Head bone
                        local onScreen, sx, sy = GetScreenCoordFromWorldCoord(bone.x, bone.y, bone.z)
                        
                        if onScreen then
                            local d = math.sqrt((sx - 0.5)^2 + (sy - 0.5)^2) * 1000
                            if d < AimbotFOV and d < bestDist then
                                bestDist = d
                                best = bone
                            end
                        end
                    end
                end
            end
            
            if best then
                local ped = PlayerPedId()
                local cam = GetGameplayCamCoord()
                local dir = vector3(best.x - cam.x, best.y - cam.y, best.z - cam.z)
                local length = math.sqrt(dir.x^2 + dir.y^2 + dir.z^2)
                dir = vector3(dir.x / length, dir.y / length, dir.z / length)
                
                local pitch = math.deg(math.asin(dir.z))
                local yaw = math.deg(math.atan2(dir.y, dir.x)) - 90
                
                SetGameplayCamRelativeRotation(pitch, 0.0, yaw)
            end
        else
            Wait(50)
        end
    end
end)

-- Normal Aimbot Thread (Snaps to target)
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.aimbot and IsControlPressed(0, 25) then -- Right mouse / Aim
            local best = nil
            local bestDist = 999999
            
            for _, p in ipairs(GetActivePlayers()) do
                if p ~= PlayerId() then
                    local ped = GetPlayerPed(p)
                    if DoesEntityExist(ped) and not IsEntityDead(ped) then
                        local bone = GetPedBoneCoords(ped, 31086, 0.0, 0.0, 0.0)
                        local onScreen, sx, sy = GetScreenCoordFromWorldCoord(bone.x, bone.y, bone.z)
                        
                        if onScreen then
                            local d = math.sqrt((sx - 0.5)^2 + (sy - 0.5)^2) * 1000
                            if d < AimbotFOV and d < bestDist then
                                bestDist = d
                                best = {ped = ped, bone = bone}
                            end
                        end
                    end
                end
            end
            
            if best then
                -- Point camera at target
                local myPed = PlayerPedId()
                local myCoords = GetEntityCoords(myPed)
                TaskAimGunAtCoord(myPed, best.bone.x, best.bone.y, best.bone.z, 100, false, false)
                
                -- Auto-shoot if armed
                if IsPedArmed(myPed, 7) then -- 7 = any weapon
                    DisablePlayerFiring(PlayerId(), false)
                end
            end
        else
            Wait(50)
        end
    end
end)

-- FOV Circle Display
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.aimbotFov and (MenuToggles.aimbot or MenuToggles.silentAimbot) then
            local screenW, screenH = GetScreenResolution()
            local centerX = 0.5
            local centerY = 0.5
            local radius = AimbotFOV / 1000
            
            -- Draw circle
            local segments = 80
            for i = 0, segments do
                local angle1 = (i / segments) * 2 * math.pi
                local angle2 = ((i + 1) / segments) * 2 * math.pi
                
                local x1 = centerX + math.cos(angle1) * radius
                local y1 = centerY + math.sin(angle1) * radius
                local x2 = centerX + math.cos(angle2) * radius
                local y2 = centerY + math.sin(angle2) * radius
                
                DrawLine(x1, y1, 1.0, x2, y2, 1.0, 255, 255, 255, 150)
            end
            
            -- Draw crosshair
            DrawRect(centerX, centerY, 0.001, 0.02, 255, 255, 255, 200)
            DrawRect(centerX, centerY, 0.02, 0.001, 255, 255, 255, 200)
        else
            Wait(100)
        end
    end
end)

-- ESP Thread
CreateThread(function()
    while true do
        Wait(0)
        if _G.MenuUnloaded then break end
        if MenuToggles.esp then
            for _, p in ipairs(GetActivePlayers()) do
                if p ~= PlayerId() then
                    local ped = GetPlayerPed(p)
                    if DoesEntityExist(ped) and not IsEntityDead(ped) then
                        local pos = GetEntityCoords(ped)
                        local headPos = GetPedBoneCoords(ped, 31086, 0.0, 0.0, 0.0)
                        local onScreen, x, y = GetScreenCoordFromWorldCoord(headPos.x, headPos.y, headPos.z + 0.3)
                        
                        if onScreen then
                            -- Player name
                            local playerName = GetPlayerName(p)
                            DrawText2D(x - 0.03, y, 0.35, playerName, 255, 255, 255, 255, 4)
                            
                            -- Distance
                            local myCoords = GetEntityCoords(PlayerPedId())
                            local dist = math.floor(#(myCoords - pos))
                            DrawText2D(x - 0.02, y + 0.02, 0.28, dist .. "m", 0, 255, 0, 255, 4)
                            
                            -- Health bar
                            local health = GetEntityHealth(ped) - 100
                            local maxHealth = GetEntityMaxHealth(ped) - 100
                            local healthPercent = health / maxHealth
                            
                            -- Background bar
                            DrawRect(x, y + 0.04, 0.05, 0.008, 0, 0, 0, 200)
                            -- Health bar
                            local healthColor = {255 * (1 - healthPercent), 255 * healthPercent, 0}
                            DrawRect(x - 0.025 + (0.025 * healthPercent), y + 0.04, 0.05 * healthPercent, 0.006, healthColor[1], healthColor[2], healthColor[3], 255)
                            
                            -- Draw box around player
                            local footPos = GetEntityCoords(ped)
                            local onScreenFoot, fx, fy = GetScreenCoordFromWorldCoord(footPos.x, footPos.y, footPos.z)
                            
                            if onScreenFoot then
                                local boxWidth = 0.04
                                local boxHeight = math.abs(y - fy)
                                
                                -- Draw corners
                                DrawRect(x - boxWidth/2, y, 0.001, boxHeight, 255, 0, 0, 200)
                                DrawRect(x + boxWidth/2, y, 0.001, boxHeight, 255, 0, 0, 200)
                                DrawRect(x, y - boxHeight/2, boxWidth, 0.001, 255, 0, 0, 200)
                                DrawRect(x, y + boxHeight/2, boxWidth, 0.001, 255, 0, 0, 200)
                            end
                        end
                    end
                end
            end
        else
            Wait(100)
        end
    end
end)

print("^5LEGEND PREMIUM v26.0 - 100% COMPLETE")
print("^3CAPS LOCK = Menu | G = FreeCam")
print("^6All server triggers added to Miscellaneous menu!")
