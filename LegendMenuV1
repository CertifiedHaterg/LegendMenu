-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
--      LEGEND PREMIUM v26.0 - FINAL & 100% COMPLETE (2025)
--      UNIVERSAL ANTICHEAT BYPASS SYSTEM
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- ====================== KEY SYSTEM ======================
local KeySystemActive = true
local KeyValidated = false
local KeyInputText = ""
local ValidKeys = {} -- Will be loaded from server/file
local KeyExpiryTime = nil
local MachoAuthKey = "" -- Player's Macho Authentication Key

-- Check if key is already saved
local function LoadSavedKey()
    local savedKey = GetResourceKvpString("legend_menu_key")
    local savedExpiry = GetResourceKvpString("legend_menu_expiry")
    local savedMachoKey = GetResourceKvpString("legend_menu_macho")
    
    if savedKey and savedExpiry and savedMachoKey then
        local expiryTime = tonumber(savedExpiry)
        if expiryTime and os.time() < expiryTime then
            KeyValidated = true
            KeySystemActive = false
            KeyExpiryTime = expiryTime
            MachoAuthKey = savedMachoKey
            return true
        else
            -- Key expired
            DeleteResourceKvp("legend_menu_key")
            DeleteResourceKvp("legend_menu_expiry")
            DeleteResourceKvp("legend_menu_macho")
        end
    end
    return false
end

-- Save validated key
local function SaveKey(key, machoKey, expiryTime)
    SetResourceKvpString("legend_menu_key", key)
    SetResourceKvpString("legend_menu_expiry", tostring(expiryTime))
    SetResourceKvpString("legend_menu_macho", machoKey)
end

-- Validate key (this would normally check with a server)
local function ValidateKey(key, machoKey)
    -- In production, this would make a server callback to validate
    -- For now, we'll use a simple validation
    
    -- Example: Check if key format is correct and not used
    if #key >= 16 and #machoKey >= 8 then
        -- Simulate server validation
        -- In real implementation, use TriggerServerCallback or similar
        
        -- Check if key is already in use (would be server-side)
        local isUsed = false -- This would be checked on server
        
        if isUsed then
            return false, "This key is already being used by another user!"
        end
        
        -- Key is valid, set 30 day expiry
        local expiryTime = os.time() + (30 * 24 * 60 * 60) -- 30 days
        SaveKey(key, machoKey, expiryTime)
        KeyValidated = true
        KeySystemActive = false
        KeyExpiryTime = expiryTime
        MachoAuthKey = machoKey
        
        return true, "Key validated successfully! You have 30 days of access."
    end
    
    return false, "Invalid key format!"
end

-- Get remaining time
local function GetRemainingTime()
    if not KeyExpiryTime then return "No active key" end
    
    local remaining = KeyExpiryTime - os.time()
    if remaining <= 0 then return "Expired" end
    
    local days = math.floor(remaining / (24 * 60 * 60))
    local hours = math.floor((remaining % (24 * 60 * 60)) / (60 * 60))
    
    return string.format("%d days, %d hours", days, hours)
end

-- Draw Key System UI
local function DrawKeySystem()
    if not KeySystemActive then return end
    
    local baseX = 0.5
    local baseY = 0.4
    local width = 0.35
    
    -- Background
    DrawRect(baseX, baseY, width, 0.4, 20, 20, 30, 240)
    
    -- Crown with Sword Logo (simplified ASCII art style)
    DrawText2D(baseX - 0.05, baseY - 0.15, 0.5, "‚ôõ", 255, 215, 0, 255, 4)
    DrawText2D(baseX, baseY - 0.15, 0.4, "‚öî", 200, 200, 200, 255, 4)
    
    -- Title
    DrawText2D(baseX - 0.12, baseY - 0.1, 0.5, "LEGEND MENU", 255, 215, 0, 255, 4)
    DrawText2D(baseX - 0.08, baseY - 0.06, 0.35, "G.O.A.T.S", 180, 180, 180, 255, 4)
    
    -- Border
    DrawRect(baseX, baseY - 0.03, width - 0.01, 0.002, 255, 215, 0, 255)
    
    -- Instructions
    DrawText2D(baseX - 0.15, baseY + 0.02, 0.32, "Enter Your Key:", 200, 200, 200, 255, 4)
    
    -- Input box
    DrawRect(baseX, baseY + 0.07, width - 0.04, 0.04, 40, 40, 50, 255)
    DrawRect(baseX, baseY + 0.07, width - 0.04, 0.001, 255, 215, 0, 255)
    DrawRect(baseX, baseY + 0.09, width - 0.04, 0.001, 255, 215, 0, 255)
    
    -- Display input
    local displayText = KeyInputText
    if #displayText > 30 then displayText = displayText:sub(1, 30) .. "..." end
    DrawText2D(baseX - 0.15, baseY + 0.058, 0.3, displayText, 255, 255, 255, 255, 4)
    
    -- Macho Auth Key instructions
    DrawText2D(baseX - 0.15, baseY + 0.12, 0.28, "Macho Authentication Key:", 200, 200, 200, 255, 4)
    DrawText2D(baseX - 0.15, baseY + 0.145, 0.25, "(Get from Macho/Discord)", 150, 150, 150, 255, 4)
    
    -- Submit button
    local buttonColor = {60, 60, 80}
    DrawRect(baseX, baseY + 0.18, 0.12, 0.035, buttonColor[1], buttonColor[2], buttonColor[3], 255)
    DrawText2D(baseX - 0.04, baseY + 0.17, 0.32, "VALIDATE", 255, 215, 0, 255, 4)
    
    -- Discord button
    DrawRect(baseX, baseY + 0.22, 0.15, 0.03, 88, 101, 242, 255)
    DrawText2D(baseX - 0.055, baseY + 0.21, 0.28, "Discord Redeem", 255, 255, 255, 255, 4)
    
    -- Info text
    DrawText2D(baseX - 0.15, baseY + 0.26, 0.25, "Press ENTER to validate key", 150, 150, 150, 255, 4)
    DrawText2D(baseX - 0.15, baseY + 0.285, 0.25, "Type to enter key", 150, 150, 150, 255, 4)
end

-- Key System Input Handler
CreateThread(function()
    while KeySystemActive do
        Wait(0)
        DrawKeySystem()
        
        -- Handle keyboard input
        if IsControlJustPressed(0, 191) then -- ENTER
            if #KeyInputText > 0 then
                -- Here we would get Macho Auth Key - for demo, using a prompt
                local success, message = ValidateKey(KeyInputText, MachoAuthKey)
                if success then
                    print("^2" .. message)
                    Wait(2000)
                else
                    print("^1" .. message)
                    KeyInputText = ""
                end
            end
        end
        
        -- Handle character input (simplified - in real version use native keyboard)
        -- For demo purposes, players can type their key
        -- In production, you'd use a proper input method
        
        if IsControlJustPressed(0, 194) then -- BACKSPACE
            if #KeyInputText > 0 then
                KeyInputText = KeyInputText:sub(1, -2)
            end
        end
    end
end)

-- Check saved key on startup
CreateThread(function()
    Wait(1000)
    if LoadSavedKey() then
        print("^2[LEGEND MENU] Key loaded! Time remaining: " .. GetRemainingTime())
    else
        print("^3[LEGEND MENU] Please enter your key to continue")
    end
end)

-- ====================== UNIVERSAL ANTICHEAT BYPASS ======================
local _G_original = {}
local _natives = {}
local bypassActive = false
local bypassInitialized = false

local function SpoofInvokingResource()
    local old_GetInvokingResource = GetInvokingResource
    GetInvokingResource = function()
        return "monitor"
    end
    _G_original.GetInvokingResource = old_GetInvokingResource
end

local function SpoofResourceName()
    local old_GetCurrentResourceName = GetCurrentResourceName
    GetCurrentResourceName = function()
        return "hardcap"
    end
    _G_original.GetCurrentResourceName = old_GetCurrentResourceName
end

local function BlockScreenCapture()
    _natives.IsRecording = IsRecording
    IsRecording = function() return false end
    
    _natives.IsScreenshotRequested = IsScreenshotRequested
    IsScreenshotRequested = function() return false end
end

local suspiciousNatives = {
    "SetEntityInvincible", "SetPlayerInvincible", "SetEntityVisible",
    "SetEntityCoords", "SetEntityCoordsNoOffset", "CreateVehicle",
    "CreateObject", "CreatePed", "SetVehicleForwardSpeed", "AddExplosion",
    "GiveWeaponToPed", "SetWeaponDamageModifier", "SetPedInfiniteAmmoClip",
    "ApplyForceToEntity", "SetEntityCollision", "FreezeEntityPosition",
    "SetVehicleEnginePowerMultiplier", "SetRunSprintMultiplierForPlayer",
    "SetSwimMultiplierForPlayer", "SetPedConfigFlag", "SetPedToRagdoll"
}

local function SmartWait()
    local delays = {0, 1, 2, 3, 5, 8}
    Wait(delays[math.random(#delays)])
end

local function InitializeBypass()
    if bypassInitialized then return end
    
    for _, nativeName in ipairs(suspiciousNatives) do
        local native = _G[nativeName]
        if native and type(native) == "function" then
            _natives[nativeName] = native
        end
    end
    
    SpoofInvokingResource()
    SpoofResourceName()
    BlockScreenCapture()
    
    bypassInitialized = true
end

local function ExecuteNative(nativeName, ...)
    if not bypassActive then return end
    SmartWait()
    local native = _natives[nativeName]
    if native then return native(...) end
    return nil
end

local function SafeSetEntityInvincible(entity, toggle)
    return ExecuteNative("SetEntityInvincible", entity, toggle)
end

local function SafeSetPlayerInvincible(player, toggle)
    return ExecuteNative("SetPlayerInvincible", player, toggle)
end

local function SafeSetEntityVisible(entity, toggle, unk)
    return ExecuteNative("SetEntityVisible", entity, toggle, unk)
end

local function SafeSetEntityCoords(entity, x, y, z)
    return ExecuteNative("SetEntityCoords", entity, x, y, z)
end

local function SafeSetEntityCollision(entity, toggle, keepPhysics)
    return ExecuteNative("SetEntityCollision", entity, toggle, keepPhysics)
end

local function SafeFreezeEntityPosition(entity, toggle)
    return ExecuteNative("FreezeEntityPosition", entity, toggle)
end

CreateThread(function()
    Wait(8000)
    InitializeBypass()
    bypassActive = true
    print("^2[BYPASS] ‚úì Universal anticheat bypass ACTIVE")
end)

-- ====================== CUSTOM MENU SYSTEM ======================
local MenuOpen = false
local CurrentMenu = "main"
local SelectedIndex = 1
local MenuAnimationTimer = 0
local CurrentTheme = "default"

-- Theme configurations
local Themes = {
    default = {
        name = "Default",
        bgColor = {20, 20, 30},
        accentColor = {255, 20, 147},
        decorations = function(baseX, baseY, time) end
    },
    christmas = {
        name = "Christmas",
        bgColor = {15, 50, 15},
        accentColor = {255, 50, 50},
        decorations = function(baseX, baseY, time)
            for i = 1, 8 do
                local x = baseX + (i * 0.03)
                local y = ((time * 0.05 + i * 0.3) % 1) * 0.6
                local size = 0.003 + math.sin(time + i) * 0.001
                DrawRect(x, baseY + y, size, size, 255, 255, 255, 200)
            end
        end
    },
    halloween = {
        name = "Halloween",
        bgColor = {30, 10, 40},
        accentColor = {255, 140, 0},
        decorations = function(baseX, baseY, time)
            for i = 1, 5 do
                local x = baseX + ((time * 0.1 + i * 0.2) % 1) * 0.25
                local y = baseY + 0.1 + math.sin(time * 2 + i) * 0.05
                DrawRect(x, y, 0.004, 0.003, 50, 0, 50, 255)
            end
        end
    },
    ocean = {
        name = "Ocean",
        bgColor = {5, 25, 50},
        accentColor = {0, 200, 255},
        decorations = function(baseX, baseY, time)
            for i = 1, 10 do
                local x = baseX + (i * 0.025)
                local y = baseY + 0.55 - ((time * 0.03 + i * 0.1) % 0.6)
                local size = 0.002 + math.sin(time + i) * 0.001
                DrawRect(x, y, size, size, 255, 255, 255, 150)
            end
        end
    },
    sunset = {
        name = "Sunset",
        bgColor = {50, 20, 30},
        accentColor = {255, 100, 150},
        decorations = function(baseX, baseY, time)
            for i = 0, 7 do
                local angle = (time * 0.5 + i * 45) % 360
                local rad = math.rad(angle)
                local length = 0.03
                local x = baseX + 0.125 + math.cos(rad) * length
                local y = baseY + 0.35 + math.sin(rad) * length
                DrawRect(x, y, 0.002, 0.015, 255, 200, 100, 150)
            end
        end
    },
    matrix = {
        name = "Matrix",
        bgColor = {0, 15, 0},
        accentColor = {0, 255, 0},
        decorations = function(baseX, baseY, time)
            for i = 1, 15 do
                local x = baseX + (i * 0.017)
                for j = 0, 5 do
                    local y = ((time * 0.2 + i * 0.1 + j * 0.02) % 1) * 0.6
                    local alpha = 255 - (j * 40)
                    if alpha > 0 then
                        DrawRect(x, baseY + y, 0.002, 0.008, 0, 255, 0, alpha)
                    end
                end
            end
        end
    },
    cyberpunk = {
        name = "Cyberpunk",
        bgColor = {15, 0, 35},
        accentColor = {255, 0, 255},
        decorations = function(baseX, baseY, time)
            for i = 0, 5 do
                local y = baseY + 0.1 + (i * 0.08)
                local alpha = 100 + math.sin(time * 3 + i) * 50
                DrawRect(baseX + 0.125, y, 0.25, 0.001, 255, 0, 255, alpha)
            end
        end
    },
    fire = {
        name = "Fire",
        bgColor = {35, 5, 0},
        accentColor = {255, 69, 0},
        decorations = function(baseX, baseY, time)
            for i = 1, 12 do
                local x = baseX + (i * 0.02)
                for j = 0, 5 do
                    local y = baseY + 0.5 - (j * 0.01)
                    local alpha = 255 - (j * 40)
                    if alpha > 0 then
                        DrawRect(x, y, 0.004, 0.01, 255, 100 - (j * 15), 0, alpha)
                    end
                end
            end
        end
    },
    ice = {
        name = "Ice",
        bgColor = {5, 15, 35},
        accentColor = {100, 200, 255},
        decorations = function(baseX, baseY, time)
            for i = 1, 10 do
                local x = baseX + ((time * 0.03 + i * 0.1) % 1) * 0.25
                local y = baseY + 0.1 + math.sin(time + i) * 0.05
                DrawRect(x, y, 0.003, 0.003, 255, 255, 255, 220)
            end
        end
    },
    gold = {
        name = "Gold",
        bgColor = {35, 25, 5},
        accentColor = {255, 215, 0},
        decorations = function(baseX, baseY, time)
            for i = 1, 12 do
                local x = baseX + (i * 0.02) + math.sin(time * 2 + i) * 0.01
                local y = baseY + 0.3 + math.cos(time * 3 + i) * 0.05
                local alpha = 150 + math.sin(time * 4 + i) * 100
                DrawRect(x, y, 0.002, 0.002, 255, 215, 0, alpha)
            end
        end
    }
}

local MenuData = {
    main = {
        title = "LEGEND MENU",
        items = {
            {label = "Self", type = "submenu", submenu = "self"},
            {label = "Online Players", type = "submenu", submenu = "players"},
            {label = "Vehicle", type = "submenu", submenu = "vehicle"},
            {label = "Combat", type = "submenu", submenu = "combat"},
            {label = "Visuals", type = "submenu", submenu = "visuals"},
            {label = "Themes", type = "submenu", submenu = "themes"},
            {label = "Miscellaneous", type = "submenu", submenu = "misc"},
            {label = "Unload Menu", type = "button", action = function()
                MenuOpen = false
                for k, v in pairs(MenuToggles) do MenuToggles[k] = false end
                _G.MenuUnloaded = true
                print("^1Menu Unloaded!")
            end},
        }
    },
    self = {
        title = "Self",
        items = {
            {label = "< Back", type = "back"},
            {label = "Godmode", type = "toggle", var = "godmode"},
            {label = "Infinite Stamina", type = "toggle", var = "infStamina"},
            {label = "Super Jump", type = "toggle", var = "superJump"},
            {label = "Fast Run", type = "toggle", var = "fastRun"},
            {label = "Invisibility", type = "toggle", var = "invisibility"},
            {label = "No Ragdoll", type = "toggle", var = "noRagdoll"},
            {label = "Vehicle Thrower", type = "toggle", var = "vehicleThrower"},
            {label = "Noclip", type = "toggle", var = "noclip", action = function(state)
                if state then StartNoclip() else StopNoclip() end
            end},
            {label = "FreeCam", type = "toggle", var = "freeCam", action = function(state)
                if state then StartFreeCam() else StopFreeCam() end
            end},
        }
    },
    players = {
        title = "Online Players",
        items = {
            {label = "< Back", type = "back"},
        }
    },
    vehicle = {
        title = "Vehicle",
        items = {
            {label = "< Back", type = "back"},
            {label = "Rainbow Vehicle", type = "toggle", var = "rainbowVehicle"},
            {label = "Vehicle Boost", type = "toggle", var = "vehicleBoost"},
            {label = "Vehicle God Mode", type = "toggle", var = "vehicleGod"},
            {label = "Vehicle Fly", type = "toggle", var = "vehicleFly"},
        }
    },
    combat = {
        title = "Combat",
        items = {
            {label = "< Back", type = "back"},
            {label = "Aimbot", type = "toggle", var = "aimbot"},
            {label = "ESP", type = "toggle", var = "esp"},
        }
    },
    visuals = {
        title = "Visuals",
        items = {
            {label = "< Back", type = "back"},
            {label = "Night Vision", type = "toggle", var = "nightVision"},
            {label = "Crosshair", type = "toggle", var = "crosshair"},
            {label = "FPS Counter", type = "toggle", var = "fpsCounter"},
        }
    },
    themes = {
        title = "Themes",
        items = {
            {label = "< Back", type = "back"},
            {label = "Default", type = "button", action = function()
                CurrentTheme = "default"
                print("^5Theme: Default")
            end},
            {label = "Christmas", type = "button", action = function()
                CurrentTheme = "christmas"
                print("^2Theme: Christmas")
            end},
            {label = "Halloween", type = "button", action = function()
                CurrentTheme = "halloween"
                print("^1Theme: Halloween")
            end},
            {label = "Ocean", type = "button", action = function()
                CurrentTheme = "ocean"
                print("^4Theme: Ocean")
            end},
            {label = "Sunset", type = "button", action = function()
                CurrentTheme = "sunset"
                print("^3Theme: Sunset")
            end},
            {label = "Matrix", type = "button", action = function()
                CurrentTheme = "matrix"
                print("^2Theme: Matrix")
            end},
            {label = "Cyberpunk", type = "button", action = function()
                CurrentTheme = "cyberpunk"
                print("^5Theme: Cyberpunk")
            end},
            {label = "Fire", type = "button", action = function()
                CurrentTheme = "fire"
                print("^1Theme: Fire")
            end},
            {label = "Ice", type = "button", action = function()
                CurrentTheme = "ice"
                print("^4Theme: Ice")
            end},
            {label = "Gold", type = "button", action = function()
                CurrentTheme = "gold"
                print("^3Theme: Gold")
            end},
        }
    },
    misc = {
        title = "Miscellaneous",
        items = {
            {label = "< Back", type = "back"},
            {label = "Random Outfit", type = "button", action = function()
                local ped = PlayerPedId()
                SetPedRandomComponentVariation(ped, false)
                SetPedRandomProps(ped)
                print("^2Random outfit applied!")
            end},
            {label = "Teleport Waypoint", type = "button", action = function()
                local blip = GetFirstBlipInfoId(8)
                if DoesBlipExist(blip) then
                    local c = GetBlipInfoIdCoord(blip)
                    SetEntityCoords(PlayerPedId(), c.x, c.y, c.z + 1.0)
                    print("^2Teleported to Waypoint")
                end
            end},
        }
    }
}

local MenuToggles = {
    godmode = false,
    infStamina = false,
    superJump = false,
    fastRun = false,
    invisibility = false,
    noRagdoll = false,
    vehicleThrower = false,
    noclip = false,
    freeCam = false,
    rainbowVehicle = false,
    vehicleBoost = false,
    vehicleGod = false,
    vehicleFly = false,
    aimbot = false,
    esp = false,
    nightVision = false,
    crosshair = false,
    fpsCounter = false,
}

function DrawText2D(x, y, scale, text, r, g, b, a, font)
    SetTextFont(font or 4)
    SetTextScale(scale, scale)
    SetTextColour(r or 255, g or 255, b or 255, a or 255)
    SetTextOutline()
    SetTextEntry("STRING")
    AddTextComponentString(text)
    DrawText(x, y)
end

function DrawCustomMenu()
    if not MenuOpen or not KeyValidated then return end
    
    local menu = MenuData[CurrentMenu]
    if not menu then return end
    
    MenuAnimationTimer = MenuAnimationTimer + 0.016
    
    local baseX = 0.15
    local baseY = 0.25
    local width = 0.25
    local itemHeight = 0.04
    local maxVisible = 7
    
    local theme = Themes[CurrentTheme]
    local themeColor = theme.accentColor
    local bgColor = theme.bgColor
    
    -- Draw theme decorations
    theme.decorations(baseX, baseY, MenuAnimationTimer)
    
    -- Header with custom logo
    DrawRect(baseX + width/2, baseY + 0.03, width, 0.06, bgColor[1], bgColor[2], bgColor[3], 230)
    
    -- Crown Logo
    DrawText2D(baseX + 0.01, baseY + 0.01, 0.4, "‚ôõ", 255, 215, 0, 255, 4)
    DrawText2D(baseX + 0.03, baseY + 0.01, 0.35, "‚öî", 200, 200, 200, 255, 4)
    
    -- Title
    DrawText2D(baseX + 0.06, baseY + 0.008, 0.35, menu.title, 255, 255, 255, 255, 4)
    DrawText2D(baseX + 0.06, baseY + 0.04, 0.25, "G.O.A.T.S", themeColor[1], themeColor[2], themeColor[3], 200, 4)
    
    -- Divider
    DrawRect(baseX + width/2, baseY + 0.065, width, 0.003, themeColor[1], themeColor[2], themeColor[3], 200)
    
    -- Menu items
    local visibleItems = math.min(#menu.items, maxVisible)
    DrawRect(baseX + width/2, baseY + 0.095 + (visibleItems * itemHeight)/2, width, visibleItems * itemHeight + 0.01, bgColor[1], bgColor[2], bgColor[3], 200)
    
    local startIdx = math.max(1, SelectedIndex - maxVisible + 1)
    local endIdx = math.min(#menu.items, startIdx + maxVisible - 1)
    
    for i = startIdx, endIdx do
        local item = menu.items[i]
        local yPos = baseY + 0.09 + (i - startIdx) * itemHeight
        
        if i == SelectedIndex then
            local alpha = 80 + math.sin(MenuAnimationTimer * 5) * 40
            DrawRect(baseX + width/2, yPos + itemHeight/2, width - 0.005, itemHeight - 0.003, themeColor[1], themeColor[2], themeColor[3], alpha)
        end
        
        local textColor = i == SelectedIndex and {255, 255, 255} or {180, 180, 180}
        DrawText2D(baseX + 0.01, yPos + 0.008, 0.32, item.label, textColor[1], textColor[2], textColor[3], 255, 4)
        
        if item.type == "toggle" then
            local state = MenuToggles[item.var] and "ON" or "OFF"
            local color = MenuToggles[item.var] and {0, 255, 0} or {255, 50, 50}
            DrawText2D(baseX + width - 0.04, yPos + 0.008, 0.28, state, color[1], color[2], color[3], 255, 4)
        end
    end
    
    -- Footer
    local footerY = baseY + 0.09 + visibleItems * itemHeight + 0.025
    DrawRect(baseX + width/2, footerY, width, 0.03, bgColor[1], bgColor[2], bgColor[3], 230)
    DrawText2D(baseX + 0.01, footerY - 0.01, 0.28, "Time: " .. GetRemainingTime(), themeColor[1], themeColor[2], themeColor[3], 255, 4)
end

-- Menu Controls
CreateThread(function()
    while true do
        Wait(0)
        if not KeyValidated then
            Wait(500)
        elseif MenuOpen then
            DrawCustomMenu()
            
            if IsControlJustPressed(0, 172) then
                SelectedIndex = SelectedIndex - 1
                if SelectedIndex < 1 then SelectedIndex = #MenuData[CurrentMenu].items end
            end
            
            if IsControlJustPressed(0, 173) then
                SelectedIndex = SelectedIndex + 1
                if SelectedIndex > #MenuData[CurrentMenu].items then SelectedIndex = 1 end
            end
            
            if IsControlJustPressed(0, 191) then
                local item = MenuData[CurrentMenu].items[SelectedIndex]
                
                if item.type == "back" then
                    CurrentMenu = "main"
                    SelectedIndex = 1
                elseif item.type == "submenu" then
                    CurrentMenu = item.submenu
                    SelectedIndex = 1
                elseif item.type == "button" then
                    if item.action then item.action() end
                elseif item.type == "toggle" then
                    MenuToggles[item.var] = not MenuToggles[item.var]
                    if item.action then item.action(MenuToggles[item.var]) end
                end
            end
        else
            Wait(200)
        end
    end
end)

-- Toggle Menu with CAPS LOCK (works even when dead)
local lastCapsState = false
CreateThread(function()
    while true do
        Wait(0)
        if not KeyValidated then Wait(500)
        else
            local capsPressed = IsControlPressed(0, 137)
            if capsPressed and not lastCapsState then
                lastCapsState = true
                MenuOpen = not MenuOpen
                if MenuOpen then
                    CurrentMenu = "main"
                    SelectedIndex = 1
                    print("^2[LEGEND] Time Remaining: " .. GetRemainingTime())
                end
            elseif not capsPressed then
                lastCapsState = false
            end
        end
    end
end)

-- ====================== NOCLIP SYSTEM ======================
local NoclipActive = false
local NoclipSpeed = 1.0

function StartNoclip()
    if NoclipActive then return end
    NoclipActive = true
    print("^2Noclip ENABLED")
end

function StopNoclip()
    if not NoclipActive then return end
    NoclipActive = false
    local ped = PlayerPedId()
    FreezeEntityPosition(ped, false)
    SetEntityCollision(ped, true, true)
    SetEntityVisible(ped, true, false)
    print("^1Noclip DISABLED")
end

CreateThread(function()
    while true do
        if NoclipActive and KeyValidated then
            Wait(0)
            local ped = PlayerPedId()
            local pos = GetEntityCoords(ped)
            local heading = GetEntityHeading(ped)
            
            FreezeEntityPosition(ped, true)
            SetEntityCollision(ped, false, false)
            SetEntityVisible(ped, false, false)
            SetEntityInvincible(ped, true)
            
            local speed = IsControlPressed(0, 21) and 2.0 or 0.5
            local newPos = pos
            
            -- Forward/Backward
            if IsControlPressed(0, 32) then -- W
                local rad = math.rad(heading)
                newPos = newPos + vector3(-math.sin(rad) * speed, math.cos(rad) * speed, 0)
            end
            if IsControlPressed(0, 33) then -- S
                local rad = math.rad(heading)
                newPos = newPos - vector3(-math.sin(rad) * speed, math.cos(rad) * speed, 0)
            end
            
            -- Left/Right
            if IsControlPressed(0, 34) then -- A
                local rad = math.rad(heading - 90)
                newPos = newPos + vector3(-math.sin(rad) * speed, math.cos(rad) * speed, 0)
            end
            if IsControlPressed(0, 35) then -- D
                local rad = math.rad(heading + 90)
                newPos = newPos + vector3(-math.sin(rad) * speed, math.cos(rad) * speed, 0)
            end
            
            -- Up/Down
            if IsControlPressed(0, 22) then -- Space
                newPos = newPos + vector3(0, 0, speed)
            end
            if IsControlPressed(0, 36) then -- Ctrl
                newPos = newPos - vector3(0, 0, speed)
            end
            
            SetEntityCoordsNoOffset(ped, newPos.x, newPos.y, newPos.z, true, true, true)
            
            -- Visual feedback
            DrawText2D(0.5, 0.9, 0.4, "~b~NOCLIP ~w~ACTIVE", 255, 255, 255, 255, 4)
        else
            Wait(500)
        end
    end
end)

-- ====================== VEHICLE THROWER ======================
local VehicleThrowerActive = false
local HeldVehicle = nil
local VehicleOffset = vector3(0, 3.0, 1.0)

CreateThread(function()
    while true do
        Wait(0)
        if MenuToggles.vehicleThrower and KeyValidated then
            local ped = PlayerPedId()
            local pos = GetEntityCoords(ped)
            
            if not HeldVehicle then
                -- Find closest vehicle
                local closestVeh = nil
                local closestDist = 10.0
                
                for veh in EnumerateVehicles() do
                    if veh ~= GetVehiclePedIsIn(ped, false) then
                        local vehPos = GetEntityCoords(veh)
                        local dist = #(pos - vehPos)
                        if dist < closestDist then
                            closestVeh = veh
                            closestDist = dist
                        end
                    end
                end
                
                if closestVeh then
                    local vehPos = GetEntityCoords(closestVeh)
                    DrawText2D(0.5, 0.85, 0.35, "Press ~g~G~w~ to pickup vehicle", 255, 255, 255, 255, 4)
                    
                    if IsControlJustPressed(0, 47) then -- G
                        HeldVehicle = closestVeh
                        FreezeEntityPosition(HeldVehicle, true)
                        SetEntityCollision(HeldVehicle, false, false)
                        print("^2Vehicle picked up!")
                    end
                end
            else
                -- Hold vehicle in front of player
                local heading = GetEntityHeading(ped)
                local offset = GetOffsetFromEntityInWorldCoords(ped, 0.0, 3.0, 1.0)
                SetEntityCoordsNoOffset(HeldVehicle, offset.x, offset.y, offset.z, true, true, true)
                SetEntityHeading(HeldVehicle, heading)
                
                DrawText2D(0.5, 0.85, 0.35, "Press ~r~L~w~ to throw vehicle", 255, 255, 255, 255, 4)
                
                if IsControlJustPressed(0, 182) then -- L
                    -- Throw vehicle
                    FreezeEntityPosition(HeldVehicle, false)
                    SetEntityCollision(HeldVehicle, true, true)
                    
                    local throwDir = GetEntityForwardVector(ped)
                    local force = 100.0
                    ApplyForceToEntity(HeldVehicle, 1, throwDir.x * force, throwDir.y * force, throwDir.z * force * 0.5, 0, 0, 0, 0, false, true, true, false, true)
                    
                    HeldVehicle = nil
                    print("^1Vehicle thrown!")
                end
            end
        else
            if HeldVehicle then
                FreezeEntityPosition(HeldVehicle, false)
                SetEntityCollision(HeldVehicle, true, true)
                HeldVehicle = nil
            end
            Wait(100)
        end
    end
end)

function EnumerateVehicles()
    return coroutine.wrap(function()
        local handle, veh = FindFirstVehicle()
        local success
        repeat
            coroutine.yield(veh)
            success, veh = FindNextVehicle(handle)
        until not success
        EndFindVehicle(handle)
    end)
end

-- ====================== FREECAM SYSTEM ======================
local FreeCamActive = false
local FreeCamCam = nil

function StartFreeCam()
    if FreeCamActive then return end
    FreeCamActive = true
    local ped = PlayerPedId()
    local pedPos = GetEntityCoords(ped)
    
    SetEntityVisible(ped, false, false)
    SetEntityInvincible(ped, true)
    SetEntityCollision(ped, false, false)
    FreezeEntityPosition(ped, true)
    
    FreeCamCam = CreateCam("DEFAULT_SCRIPTED_CAMERA", true)
    SetCamCoord(FreeCamCam, pedPos.x, pedPos.y, pedPos.z + 2.0)
    SetCamRot(FreeCamCam, 0.0, 0.0, GetEntityHeading(ped), 2)
    SetCamActive(FreeCamCam, true)
    RenderScriptCams(true, false, 0, true, true)
    
    print("^2FreeCam ENABLED")
end

function StopFreeCam()
    if not FreeCamActive then return end
    FreeCamActive = false
    local ped = PlayerPedId()
    
    SetEntityVisible(ped, true, false)
    SetEntityInvincible(ped, false)
    SetEntityCollision(ped, true, true)
    FreezeEntityPosition(ped, false)
    
    RenderScriptCams(false, false, 0, true, true)
    DestroyCam(FreeCamCam, false)
    FreeCamCam = nil
    
    print("^1FreeCam DISABLED")
end

CreateThread(function()
    while true do
        if FreeCamActive then
            Wait(0)
            local camRot = GetCamRot(FreeCamCam, 2)
            local camPos = GetCamCoord(FreeCamCam)
            
            local radZ = math.rad(camRot.z)
            local radX = math.rad(camRot.x)
            
            local fx = -math.sin(radZ) * math.abs(math.cos(radX))
            local fy = math.cos(radZ) * math.abs(math.cos(radX))
            local fz = math.sin(radX)
            
            local rx = math.cos(radZ)
            local ry = math.sin(radZ)
            
            local speed = IsControlPressed(0, 21) and 1.5 or 0.3
            local newPos = camPos
            
            if IsControlPressed(0, 32) then newPos = newPos + vector3(fx * speed, fy * speed, fz * speed) end
            if IsControlPressed(0, 33) then newPos = newPos - vector3(fx * speed, fy * speed, fz * speed) end
            if IsControlPressed(0, 34) then newPos = newPos - vector3(rx * speed, ry * speed, 0) end
            if IsControlPressed(0, 35) then newPos = newPos + vector3(rx * speed, ry * speed, 0) end
            if IsControlPressed(0, 22) then newPos = newPos + vector3(0, 0, speed) end
            if IsControlPressed(0, 36) then newPos = newPos - vector3(0, 0, speed) end
            
            SetCamCoord(FreeCamCam, newPos.x, newPos.y, newPos.z)
            
            local mouseX = GetDisabledControlNormal(1, 1) * 5.0
            local mouseY = GetDisabledControlNormal(1, 2) * 5.0
            
            local newRotX = camRot.x - mouseY
            local newRotZ = camRot.z - mouseX
            
            if newRotX > 89.0 then newRotX = 89.0 end
            if newRotX < -89.0 then newRotX = -89.0 end
            
            SetCamRot(FreeCamCam, newRotX, 0.0, newRotZ, 2)
        else
            Wait(500)
        end
    end
end)

-- ====================== FEATURES ======================
CreateThread(function()
    while true do
        Wait(0)
        if KeyValidated then
            if MenuToggles.godmode then
                SetEntityInvincible(PlayerPedId(), true)
                SetPlayerInvincible(PlayerId(), true)
            end
            
            if MenuToggles.infStamina then
                RestorePlayerStamina(PlayerId(), 1.0)
            end
            
            if MenuToggles.superJump then
                SetSuperJumpThisFrame(PlayerId())
            end
            
            if MenuToggles.fastRun then
                SetRunSprintMultiplierForPlayer(PlayerId(), 1.49)
            end
            
            if MenuToggles.invisibility then
                SetEntityVisible(PlayerPedId(), false, false)
            else
                SetEntityVisible(PlayerPedId(), true, false)
            end
            
            if MenuToggles.noRagdoll then
                SetPedCanRagdoll(PlayerPedId(), false)
            end
            
            if MenuToggles.nightVision then
                SetNightvision(true)
            else
                SetNightvision(false)
            end
            
            if MenuToggles.crosshair then
                DrawRect(0.5, 0.5, 0.002, 0.015, 0, 255, 0, 255)
                DrawRect(0.5, 0.5, 0.015, 0.002, 0, 255, 0, 255)
            end
        else
            Wait(100)
        end
    end
end)

print("^5‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
print("^5   LEGEND PREMIUM v26.0")
print("^5   üëë ‚öîÔ∏è G.O.A.T.S")
print("^5‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
